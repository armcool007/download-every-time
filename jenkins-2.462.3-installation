#!/bin/bash
set -e

# 1. Install Java 17 (required for Jenkins 2.357+)
sudo apt update
sudo apt install -y openjdk-17-jdk

# 2. Download Jenkins 2.462.3 .deb package directly
wget https://pkg.jenkins.io/debian-stable/binary/jenkins_2.462.3_all.deb

# 3. Install the package (with dependencies)
sudo dpkg -i jenkins_2.462.3_all.deb || sudo apt --fix-broken -y install

# 4. Prevent auto-upgrade (critical!)
sudo apt-mark hold jenkins

# 5. Start Jenkins
sudo systemctl daemon-reload
sudo systemctl enable --now jenkins

# 6. Show status and initial password
echo "âœ… Jenkins 2.462.3 installed!"
echo "ğŸŒ Access at: http://$(hostname -I | awk '{print $1}'):8080"
echo "ğŸ”‘ Initial admin password:"
sudo cat /var/lib/jenkins/secrets/initialAdminPassword
